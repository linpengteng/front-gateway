!function(){"use strict";importScripts("/net-gateway-config.js");const e=e=>"[object WindowClient]"===Object.prototype.toString.call(e),t=e=>"[object Object]"===Object.prototype.toString.call(e),r=e=>"[object Array]"===Object.prototype.toString.call(e),s=(e={})=>{a.has(e?.id)&&a.get(e.id).port?.postMessage({id:e.id,uid:e.uid,type:e.type,certs:e?.certs||null,clients:e?.clients||null,result:e?.result||null,error:e?.error||null})},i=(e,s={})=>{switch(e){case"clear":n.clear();break;case"reset":if(n.clear(),t(s))for(const e in s)n.set(e,s[e]);break;case"update":if(t(s))for(const e in s)n.set(e,s[e]);break;case"remove":if(r(s))for(const e of s)n.delete(e);if(t(s))for(const e in s)n.delete(e)}},c=(e,i={})=>{switch(e){case"clear":a.clear();break;case"reset":if(a.clear(),t(i))for(const e in i)a.set(e,{...a.get(e),...i[e],port:a.get(e)?.port});break;case"update":if(t(i))for(const e in i)a.set(e,{...a.get(e),...i[e],port:a.get(e)?.port});break;case"remove":if(r(i))for(const e of i)a.delete(e);if(t(i))for(const e in i)a.delete(e);break;case"checkup":self.clients.matchAll().then((e=>{const s=t(i)?Object.keys(i):r(i)?i:[];for(const t of a.keys()){const r=s.some((e=>t===e)),i=e.some((e=>t===e.id));r||i||a.delete(t)}}));break;case"synchrony":{const e=t(i)?Object.keys(i):r(i)?i:[];for(const t of e)c=t,"[object String]"===Object.prototype.toString.call(c)&&s({id:t,uid:"[NET_SYNC_ID]",type:"[CALL:NET_SYNC]",certs:Object.fromEntries(n.entries()),clients:{[t]:{...a.get(t),port:null}}});break}}var c};self.addEventListener("install",(e=>{e.waitUntil(self.skipWaiting())})),self.addEventListener("activate",(e=>{e.waitUntil(self.clients.claim())})),self.addEventListener("message",(r=>{if(!e(r.source))return;if(!t(r.data))return;const o=r.source.id;r.data.uid;const l=r.data.type,d=r.ports[0],u=r.data.certs||{},p={[o]:r.data.clients?.[o]};o&&"[CHANNEL:TRANSFER]"===l&&(((e,t)=>{a.has(e)&&(a.get(e).port=t),a.has(e)||a.set(e,{id:e,port:t,rewrite:"/"}),t.onmessage=t=>{const r=t.data?.uid,c=t.data?.type,o=t.data?.certs;switch(c){case"[CALL:NET_PING]":s({id:e,uid:r,type:c});break;case"[CALL:CLEAR_CERTER]":i("clear",o),a.forEach((t=>s({id:t.id,uid:t.id===e?r:null,type:t.id===e?c:"[CALL:NET_PING]",certs:Object.fromEntries(n.entries())})));break;case"[CALL:RESET_CERTER]":i("reset",o),a.forEach((t=>s({id:t.id,uid:t.id===e?r:null,type:t.id===e?c:"[CALL:NET_PING]",certs:Object.fromEntries(n.entries())})));break;case"[CALL:UPDATE_CERTER]":i("update",o),a.forEach((t=>s({id:t.id,uid:t.id===e?r:null,type:t.id===e?c:"[CALL:NET_PING]",certs:Object.fromEntries(n.entries())})));break;case"[CALL:REMOVE_CERTER]":i("remove",o),a.forEach((t=>s({id:t.id,uid:t.id===e?r:null,type:t.id===e?c:"[CALL:NET_PING]",certs:Object.fromEntries(n.entries())})));break;case"[CALL:BROADCAST_MESSAGE]":a.forEach(((r,s)=>{s!==e&&a.get(s)?.port.postMessage({...t.data})}))}}})(o,d),i("update",u),c("update",p),c("synchrony",[o]),c("checkup",[o]))})),self.addEventListener("fetch",(t=>{let r="/";const s=t.request,i=NetDebug,l=NetGateway,d=o.has(s.url),u="navigate"===s.mode,p=NetWhites.some((e=>e.test(s.url))),f=NetProxys.some((e=>e.test(s.url))),h=[NetSubRoute].some((e=>e.test(s.url))),E=[NetSubRoute].some((e=>e.test(s.referrer))),b=t.resultingClientId||t.clientId,g=t.clientId;if(f&&o.has(s.url)&&o.delete(s.url),f&&a.has(b)&&(d||(r=a.get(b)?.rewrite||"/"),d&&a.delete(b)),f&&!a.has(b)&&(!d&&u&&E&&(r=s.referrer.replace(NetSubRoute,"$1")),!d&&u&&h&&(r=s.url.replace(NetSubRoute,"$1")),a.set(b,{id:b,rewrite:r}),c("synchrony",[b]),c("checkup",[b])),f&&l&&u&&!h&&!p&&"/"!==r)return t.respondWith(Response.redirect(s.url.replace(NetSubRewirte,`$1${r}`),302));if(f&&l){const r=async r=>{const s=a.get(b).rewrite,c=p||h?r.url:r.url.replace(NetSubRewirte,`$1${s}`),l=/^(GET|HEAD)$/i.test(r.method)?null:await r.clone().arrayBuffer().catch((()=>null)),d=/^(GET|HEAD)$/i.test(r.method)?null:await r.clone().json().catch((()=>null)),f=Object.fromEntries([...t.request.headers.entries(),...n.entries()]),E=new Request(c,{cache:r.cache,signal:r.signal,method:r.method,priority:r.priority,redirect:u&&["follow","error","manual"].includes(NetRedirect)?NetRedirect:r.redirect,referrer:r.referrer,integrity:r.integrity,keepalive:r.keepalive,credentials:r.credentials,referrerPolicy:r.referrerPolicy,headers:f||{},body:l||null,mode:"same-origin"});if(i){const e=E.url,t=E.method,s=((e="")=>{const t=console.log,r=console.group,s=console.groupEnd;return i=>{t("\n"),r(`------- NetWork: -> ${e} ---------`),i(t),s(),t("\n")}})(r.url);s((r=>{r("[Url] - ",e),r("[Method] - ",t),r("[Headers] - ",f),r("[ParseBody] - ",d)}))}const y=fetch(E),S=self.clients.get(g),m=a.get(g),N=(t,r)=>{const i=e(t),c=r?.headers?.get("redirect-url")?.trim()||m?.redirect?.trim(),n="manual"===E.redirect,l="/"!==s;if(a.get(g)?.redirect&&delete a.get(g).redirect,i||u||!c||(a.get(b).redirect=c),!i&&u&&c){let e=c;const t=/^(https?:\/\/?[^\/]+)(\?[\s\S]*)?$/i.test(e);return!/^(https?:\/\/)?(localhost|127\.0\.0\.1)([:/][\s\S]*)?$/i.test(e)&&(e=e.replace(/^https?:\/\/([\s\S]+(\?[\s\S]*)?)$/i,"https://$1")),t&&(e=e.replace(/^(https?:\/\/[^\/]+)(\?[\s\S]*)?$/i,"$1/$2")),o.add(e),Response.redirect(e,302)}if(i&&c){let e=c;const r=/^(https?:\/\/?[^\/]+)(\?[\s\S]*)?$/i.test(e);return!/^(https?:\/\/)?(localhost|127\.0\.0\.1)([:/][\s\S]*)?$/i.test(e)&&(e=e.replace(/^https?:\/\/([\s\S]+(\?[\s\S]*)?)$/i,"https://$1")),r&&(e=e.replace(/^(https?:\/\/[^\/]+)(\?[\s\S]*)?$/i,"$1/$2")),o.add(e),t.navigate(e)}return y.then((e=>{if(n&&i){const r=e.redirected,i=NetWhites.some((t=>t.test(e.url))),c=NetProxys.some((t=>t.test(e.url))),a=[NetSubRoute].some((t=>t.test(e.url))),n=/^(https?:\/\/?[^\/]+)(\?[\s\S]*)?$/i.test(e.url),d=/^(https?:\/\/)?(localhost|127\.0\.0\.1)([:/][\s\S]*)?$/i.test(e.url);if(r&&c&&!i&&!a){let r=e.url;return!d&&(r=r.replace(/^https?:\/\/([\s\S]+(\?[\s\S]*)?)$/i,"https://$1")),n&&(r=r.replace(/^(https?:\/\/[^\/]+)(\?[\s\S]*)?$/i,"$1/$2")),l&&(r=r.replace(NetSubRewirte,`$1${s}`)),o.add(r),t.navigate(r)}}return e}))};return Promise.all([S,y]).then((e=>N(...e))).catch((()=>N()))};t.respondWith(r(s))}}));const o=new Set,a=new Map,n=new Map}();
